SET TERM ^ ;
ALTER PROCEDURE USPGETNEXTMAINTLIST (
    IN_USERKEY Varchar(36),
    IN_RVKEYS Varchar(8000) DEFAULT NULL,
    IN_CVKEYS Varchar(8000) DEFAULT NULL,
    IN_LVKEYS Varchar(8000) DEFAULT NULL,
    IN_MOVKEYS Varchar(8000) DEFAULT NULL,
    IN_SHOWRV Char(1) DEFAULT 'F',
    IN_SHOWCV Char(1) DEFAULT 'F',
    IN_SHOWLV Char(1) DEFAULT 'F',
    IN_SHOWMOV Char(1) DEFAULT 'F',
    IN_SHOWINGRID Char(1) DEFAULT 'F',
    IN_GRIDDATASOURCE Varchar(100) DEFAULT NULL,
    IN_USINGFIELD Varchar(1000) DEFAULT NULL,
    IN_DATEFROM Varchar(10) DEFAULT NULL,
    IN_DATETO Varchar(10) DEFAULT NULL,
    IN_LIMITDUETYPE Varchar(10) DEFAULT 'ALL',
    IN_SELECTEDDATES Varchar(8000) DEFAULT NULL,
    IN_SELECTEDDATETYPE Varchar(10) DEFAULT NULL,
    IN_FILTERCLAUSE Varchar(8000) DEFAULT NULL,
    IN_SHOWEQUIPFIELDS Char(1) DEFAULT 'F' )
RETURNS (
    RETMULDATASETS Char(1),
    SQL Varchar(30000) )
AS
/*
SELECT p.*
FROM USPGETNEXTMAINTLIST('6621481315992959468 ',null, null, null, null, 'T', 'F', 'F', 'F', 'T', 'uspGetRVList', 'NEXTMAINDATE',  '1900/01/01',  '9999/01/01', 'ALL') p
*/
/*
**  File:        uspGetNextMaintList.sql
**  Description: Returns Next Maint Date Analysis List
**  Returns:     
**  Params:     

*******************************************************************************
**  Change History
*******************************************************************************
**	Author	        Date				TFS	    Description
**	Tony.Cai	    2010/10/28	n/a  		Original.
**	Marco Cao    2011/08/26    YES		Show same columns with repairlist
**	Ben Song    2018/03/14    YES		DE82900:  VKV:"Due Date" analyse depend on equiptype in valve calendar menu
*/ 
    DECLARE VARIABLE CREATEDATE VARCHAR(30); 
    DECLARE VARIABLE HowManyEquipTypes INTEGER; 
    DECLARE VARIABLE DisplayColumns VARCHAR(20000);
	DECLARE VARIABLE OwnerPartSql VARCHAR(1000);
	DECLARE VARIABLE PlantPartSql VARCHAR(1000);
	DECLARE VARIABLE LimitDueTypePartSql VARCHAR(1000);
	DECLARE VARIABLE CDATE VARCHAR(30);
	DECLARE VARIABLE POS Integer;
	DECLARE VARIABLE EquipTable VARCHAR(25);
	DECLARE VARIABLE EquipType VARCHAR(25);	
    DECLARE VARIABLE DATEDUE VARCHAR(25);	
BEGIN
	CREATEDATE = CAST (CURRENT_TIMESTAMP AS VARCHAR(30));
	RETMULDATASETS = 'T';
	
	IF (IN_DateFrom IS NULL OR IN_DateFrom = '') THEN
	BEGIN
		IN_DateFrom = '1900/01/01';
	END
	
	IF (IN_DateTo IS NULL OR IN_DateTo = '') THEN
	BEGIN
		IN_DateTo = '2900/01/01';
	END
	
	DELETE FROM TEMPKEYLIST;
		
	INSERT INTO TEMPKEYLIST
	(
		UNIQUEKEY,
		CREATEDATE
	)
	SELECT	p.UNIQUEKEY, :CREATEDATE
	FROM	USPGETKEYLISTBYFILTER(:IN_USERKEY, :IN_RVKEYS, :IN_CVKEYS, :IN_LVKEYS, :IN_MOVKEYS, :IN_SHOWRV, :IN_SHOWCV, :IN_SHOWLV, :IN_SHOWMOV, :IN_SHOWINGRID, :IN_GRIDDATASOURCE, :IN_USINGFIELD, :IN_SELECTEDDATES, :IN_SELECTEDDATETYPE, :IN_FILTERCLAUSE) p;
	
	HowManyEquipTypes = 0;

	IF (IN_ShowRV = 'T') THEN
	BEGIN
		HowManyEquipTypes = HowManyEquipTypes + 1;
	END
	
	IF (IN_ShowCV = 'T') THEN
	BEGIN
		HowManyEquipTypes = HowManyEquipTypes + 1;
	END
	
	IF (IN_ShowLV = 'T') THEN
	BEGIN
		HowManyEquipTypes = HowManyEquipTypes + 1;
	END
	
	IF (IN_ShowMOV = 'T') THEN
	BEGIN
		HowManyEquipTypes = HowManyEquipTypes + 1;
	END
	
	IF (HowManyEquipTypes > 1 OR IN_ShowEquipFields = 'T') THEN
	BEGIN	
		IF (IN_ShowRV = 'T') THEN
		BEGIN
			IF (IN_UsingField = 'BOTHDATE') THEN
			BEGIN
				SQL = ' SELECT	a.UNIQUEKEY,''RV '' AS EQUIPTYPE,LOOPNUMBER,TAGNUMBER,SERIAL,UNIT,EQUIPLOCN,STATUS,JOBNUMBER,MODELNUMBER,MANUFACTURER,RISK,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) BOTHDATE,
								IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, NULL AS DATEDUE,
								DATEDIFF(DAY,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) DAYDUE,
								DATEDIFF(DAY,DATEADD(DAY,-EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY,-EXTRACT(WEEKDAY FROM CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)), CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)))/7 WEEKDUE,
								DATEDIFF(MONTH,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) MONTHDUE,
								DATEDIFF(YEAR,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) YEARDUE
						FROM RELIEFD a JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						WHERE MOSTRECENT = ''T'' 
						AND		((ISDATE(NEXTMAINDATE) = 1 AND NEXTMAINDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || ''')
							OR	(ISDATE(NEXTTESTDATE) = 1 AND NEXTTESTDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''))';
			END
			ELSE
			BEGIN
				SQL = ' SELECT	a.UNIQUEKEY,''RV '' AS EQUIPTYPE,LOOPNUMBER,TAGNUMBER,SERIAL,UNIT,EQUIPLOCN,STATUS,JOBNUMBER,MODELNUMBER,MANUFACTURER,RISK,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,
								IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, NULL AS DATEDUE,
								DATEDIFF(DAY,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) DAYDUE,
								DATEDIFF(DAY,DATEADD(DAY,-EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY,-EXTRACT(WEEKDAY FROM CAST(' || :IN_UsingField || ' AS DATE)), CAST(' || :IN_UsingField || ' AS DATE)))/7 WEEKDUE,
								DATEDIFF(MONTH,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) MONTHDUE,
								DATEDIFF(YEAR,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) YEARDUE
						FROM RELIEFD a JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						WHERE MOSTRECENT = ''T'' AND ISDATE(' || IN_UsingField || ') = 1 AND ' || IN_UsingField || ' BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''';
			END
		END
		
		IF (IN_ShowCV = 'T') THEN
		BEGIN
			IF (SQL IS NULL) THEN
			BEGIN
				SQL = '';
			END
			ELSE
			BEGIN
				SQL = SQL || ' UNION ';
			END
			

			IF (IN_UsingField = 'BOTHDATE') THEN
			BEGIN
				SQL =	SQL || 'SELECT a.UNIQUEKEY,''CV '' AS EQUIPTYPE,LOOPNUMBER,TAGNUMBER,SERIAL,UNIT,EQUIPLOCN,STATUS,JOBNUMBER,MODELNUMBER,MANUFACTURER,RISK,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) BOTHDATE,
								IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, NULL AS DATEDUE,
								DATEDIFF(DAY,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) DAYDUE,
								DATEDIFF(DAY,DATEADD(DAY,-EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY,-EXTRACT(WEEKDAY FROM CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)), CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)))/7 WEEKDUE,
								DATEDIFF(MONTH,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) MONTHDUE,
								DATEDIFF(YEAR,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) YEARDUE
						FROM CV a JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						WHERE MOSTRECENT = ''T'' 
						AND		((ISDATE(NEXTMAINDATE) = 1 AND NEXTMAINDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || ''')
							OR	(ISDATE(NEXTTESTDATE) = 1 AND NEXTTESTDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''))';
			END
			ELSE
			BEGIN
				SQL =	SQL || 'SELECT a.UNIQUEKEY,''CV '' AS EQUIPTYPE,LOOPNUMBER,TAGNUMBER,SERIAL,UNIT,EQUIPLOCN,STATUS,JOBNUMBER,MODELNUMBER,MANUFACTURER,RISK,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,
								IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, NULL AS DATEDUE,
								DATEDIFF(DAY,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) DAYDUE,
								DATEDIFF(DAY,DATEADD(DAY,-EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY,-EXTRACT(WEEKDAY FROM CAST(' || :IN_UsingField || ' AS DATE)), CAST(' || :IN_UsingField || ' AS DATE)))/7 WEEKDUE,
								DATEDIFF(MONTH,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) MONTHDUE,
								DATEDIFF(YEAR,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) YEARDUE
						FROM CV a JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						WHERE MOSTRECENT = ''T'' AND ISDATE(' || IN_UsingField || ') = 1 AND ' || IN_UsingField || ' BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''';
			END
		END
		
		IF (IN_ShowLV = 'T') THEN
		BEGIN
			IF (SQL IS NULL) THEN
			BEGIN
				SQL = '';
			END
			ELSE
			BEGIN
				SQL = SQL || ' UNION ';
			END

			IF (IN_UsingField = 'BOTHDATE') THEN
			BEGIN
				SQL =	SQL || 'SELECT a.UNIQUEKEY,''LV '' AS EQUIPTYPE,LOOPNUMBER,TAGNUMBER,SERIAL,UNIT,EQUIPLOCN,STATUS,JOBNUMBER,MODELNUMBER,MANUFACTURER,RISK,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) BOTHDATE,
								IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, NULL AS DATEDUE,
								DATEDIFF(DAY,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) DAYDUE,
								DATEDIFF(DAY,DATEADD(DAY,-EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY,-EXTRACT(WEEKDAY FROM CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)), CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)))/7 WEEKDUE,
								DATEDIFF(MONTH,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) MONTHDUE,
								DATEDIFF(YEAR,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) YEARDUE
						FROM LINEV a JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						WHERE MOSTRECENT = ''T'' 
						AND		((ISDATE(NEXTMAINDATE) = 1 AND NEXTMAINDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || ''')
							OR	(ISDATE(NEXTTESTDATE) = 1 AND NEXTTESTDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''))';
			END
			ELSE
			BEGIN
				SQL =	SQL || 'SELECT a.UNIQUEKEY,''LV '' AS EQUIPTYPE,LOOPNUMBER,TAGNUMBER,SERIAL,UNIT,EQUIPLOCN,STATUS,JOBNUMBER,MODELNUMBER,MANUFACTURER,RISK,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,
								IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, DATEDUE,
								DATEDIFF(DAY,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) DAYDUE,
								DATEDIFF(DAY,DATEADD(DAY,-EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY,-EXTRACT(WEEKDAY FROM CAST(' || :IN_UsingField || ' AS DATE)), CAST(' || :IN_UsingField || ' AS DATE)))/7 WEEKDUE,
								DATEDIFF(MONTH,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) MONTHDUE,
								DATEDIFF(YEAR,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) YEARDUE
						FROM LINEV a JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						WHERE MOSTRECENT = ''T'' AND ISDATE(' || IN_UsingField || ') = 1 AND ' || IN_UsingField || ' BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''';
			END
		END
		
		IF (IN_ShowMOV = 'T') THEN
		BEGIN
			IF (SQL IS NULL) THEN
			BEGIN
				SQL = '';
			END
			ELSE
			BEGIN
				SQL = SQL || ' UNION ';
			END

			IF (IN_UsingField = 'BOTHDATE') THEN
			BEGIN
				SQL =	SQL || 'SELECT a.UNIQUEKEY,''MOV'' AS EQUIPTYPE,LOOPNUMBER,TAGNUMBER,SERIAL,UNIT,EQUIPLOCN,STATUS,JOBNUMBER,MODELNUMBER,MANUFACTURER,RISK,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) BOTHDATE,
								IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, NULL AS DATEDUE,
								DATEDIFF(DAY,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) DAYDUE,
								DATEDIFF(DAY,DATEADD(DAY,-EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY,-EXTRACT(WEEKDAY FROM CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)), CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)))/7 WEEKDUE,
								DATEDIFF(MONTH,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) MONTHDUE,
								DATEDIFF(YEAR,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) YEARDUE
						FROM MOV a JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						WHERE MOSTRECENT = ''T'' 
						AND		((ISDATE(NEXTMAINDATE) = 1 AND NEXTMAINDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || ''')
							OR	(ISDATE(NEXTTESTDATE) = 1 AND NEXTTESTDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''))';
			END
			ELSE
			BEGIN
				SQL =	SQL || 'SELECT a.UNIQUEKEY,''MOV'' AS EQUIPTYPE,LOOPNUMBER,TAGNUMBER,SERIAL,UNIT,EQUIPLOCN,STATUS,JOBNUMBER,MODELNUMBER,MANUFACTURER,RISK,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,
								IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, DATEDUE,
								DATEDIFF(DAY,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) DAYDUE,
								DATEDIFF(DAY,DATEADD(DAY,-EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY,-EXTRACT(WEEKDAY FROM CAST(' || :IN_UsingField || ' AS DATE)), CAST(' || :IN_UsingField || ' AS DATE)))/7 WEEKDUE,
								DATEDIFF(MONTH,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) MONTHDUE,
								DATEDIFF(YEAR,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) YEARDUE
						FROM MOV a JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						WHERE MOSTRECENT = ''T'' AND ISDATE(' || IN_UsingField || ') = 1 AND ' || IN_UsingField || ' BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''';
			END
		END
	
		SQL = 'SELECT * FROM (' || SQL || ')';

		IF (IN_LimitDueType = 'PAST') THEN
		BEGIN
			SQL = SQL || ' WHERE DAYDUE < 0';
		END
		ELSE IF (IN_LimitDueType = 'TODAY') THEN
		BEGIN
			SQL = SQL || ' WHERE DAYDUE = 0';
		END
		ELSE IF (IN_LimitDueType = 'COMING') THEN
		BEGIN
			SQL = SQL || ' WHERE DAYDUE > 0';
		END
	END
	ELSE
	BEGIN
		EXECUTE PROCEDURE uspPrepareGridFieldsNoCountCust(IN_UserKey,  '', IN_GridDataSource) RETURNING_VALUES(CDATE);
	
		SELECT	LIST(FIELDNAME, ',a.')
		FROM	TEMPGRIDFIELD t
		WHERE	DATATABLE <> 'GRIDCUSTOMIZEDFIELD' 
		AND		CREATEDATE  = :CDATE 
		AND		NOT EXISTS (SELECT FIELDNAME FROM GRIDDEFAULTFIELD WHERE GRIDDATASOURCE = 'uspGetNextMaintList' AND QUERYTYPE = 'SELECT' AND FIELDNAME = t. FIELDNAME ) 
		INTO	:DisplayColumns;
		
		DisplayColumns = 'a.' || DisplayColumns;
		
		OwnerPartSql = '';
		PlantPartSql = '';
		
		DisplayColumns = REPLACE(DisplayColumns, 'a.OWNERNAME', 'OWNERNAME');
		DisplayColumns = REPLACE(DisplayColumns, 'a.LOCATION', 'LOCATION');
		DisplayColumns = REPLACE(DisplayColumns, 'a.AREA', 'AREA');        
        DisplayColumns = REPLACE(DisplayColumns, 'a.CALCULATEDDATE', 'CALCULATEDDATE');        
        select p.ResultColumns from uspAppendCalculationField(:DisplayColumns,:IN_UserKey,:IN_GridDataSource) p into :DisplayColumns;
        
		POS = 0;
		POS = POSITION('LOOPNUMBER' IN :DisplayColumns);
			
		IF(POS=0) THEN
		BEGIN
			DisplayColumns = DisplayColumns || ',a.LOOPNUMBER';
		END
			
		POS = 0;    				    
		POS = POSITION('OWNERNAME' IN :DisplayColumns);
		
		IF(POS>0) THEN
		BEGIN
			OwnerPartSql = ' LEFT JOIN OWNERS own ON own.UNIQUEKEY = a.OWNERKEY ';
		END
		
		POS = 0;
		POS = POSITION('LOCATION' IN :DisplayColumns);
		
		IF(POS=0) THEN
		BEGIN
			POS = POSITION('AREA' IN :DisplayColumns);
		END
		
		IF(POS>0) THEN
		BEGIN
			PlantPartSql = ' LEFT JOIN PLANTS pla ON pla.UNIQUEKEY = a.PLANTKEY  ';
		END
		
	    IF (IN_ShowRV = 'T') THEN
        BEGIN
            EquipTable = 'ReliefD';
            EquipType = 'RV ';
            DATEDUE = null;
        END
        ELSE IF (IN_ShowCV = 'T') THEN
        BEGIN
            EquipTable = 'CV';
            EquipType = 'CV ';
            DATEDUE = null;
        END	
        ELSE IF (IN_ShowMOV = 'T') THEN
        BEGIN
            EquipTable = 'MOV';
            EquipType = 'MOV';
            DATEDUE = 'DATEDUE';
        END
        ELSE IF (IN_ShowLV = 'T') THEN
        BEGIN
            EquipTable = 'LineV';
            EquipType = 'LV ';
            DATEDUE = 'DATEDUE';
        END

		IF (IN_LimitDueType = 'PAST') THEN
		BEGIN
			LimitDueTypePartSql = ' WHERE DAYDUE < 0';
		END
		ELSE IF (IN_LimitDueType = 'TODAY') THEN
		BEGIN
			LimitDueTypePartSql = ' WHERE DAYDUE = 0';
		END
		ELSE IF (IN_LimitDueType = 'COMING') THEN
		BEGIN
			LimitDueTypePartSql = ' WHERE DAYDUE > 0';
		END
		ELSE
		BEGIN
			LimitDueTypePartSql = '';
		END

		IF (IN_UsingField = 'BOTHDATE') THEN
		BEGIN
			SQL = '	SELECT *  FROM (SELECT  a.UNIQUEKEY, ' || DisplayColumns || ', ''' || EquipType || ''' AS EQUIPTYPE,
						TAGNUMBER,SERIAL,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) BOTHDATE,
						IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, NULL AS DATEDUE,
						DATEDIFF(DAY,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) DAYDUE,
						DATEDIFF(DAY,DATEADD(DAY, -EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY, -EXTRACT(WEEKDAY FROM CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)), CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)))/7 WEEKDUE,
						DATEDIFF(MONTH,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) MONTHDUE,
						DATEDIFF(YEAR,CURRENT_DATE,CAST(MINVALUE(IIF(ISDATE(NEXTMAINDATE)=0,''2999/12/30'', NEXTMAINDATE),IIF(ISDATE(NEXTTESTDATE)=0, ''2999/12/30'', NEXTTESTDATE)) AS DATE)) YEARDUE
						FROM ' || EquipTable || ' a
						JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						' || OwnerPartSql || PlantPartSql || ' 
						WHERE MOSTRECENT = ''T'' 
						AND		((ISDATE(NEXTMAINDATE) = 1 AND NEXTMAINDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || ''')
							OR	(ISDATE(NEXTTESTDATE) = 1 AND NEXTTESTDATE BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || '''))) result' || LimitDueTypePartSql;
		END
		ELSE
		BEGIN
			SQL = '	SELECT *  FROM (SELECT  a.UNIQUEKEY, ' || DisplayColumns || ', ''' || EquipType || ''' AS EQUIPTYPE,
						TAGNUMBER,SERIAL,DATETESTED,NEXTMAINDATE,NEXTTESTDATE,NEXTINSPDATE,
						IIF(ISDATE(DATETESTED)=0,NULL,DATEDIFF(DAY,CAST(DATETESTED AS DATE),CURRENT_DATE)) AS REPAIRDAYDUE, '|| :DATEDUE || ' AS DATEDUE,
						DATEDIFF(DAY,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) DAYDUE,
						DATEDIFF(DAY,DATEADD(DAY, -EXTRACT(WEEKDAY FROM CURRENT_DATE), CURRENT_DATE), DATEADD(DAY, -EXTRACT(WEEKDAY FROM CAST(' || :IN_UsingField || ' AS DATE)), CAST(' || :IN_UsingField || ' AS DATE)))/7 WEEKDUE,
						DATEDIFF(MONTH,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) MONTHDUE,
						DATEDIFF(YEAR,CURRENT_DATE,CAST(' || :IN_UsingField || ' AS DATE)) YEARDUE
						FROM ' || EquipTable || ' a
						JOIN TEMPKEYLIST b ON (b.UNIQUEKEY = a.UNIQUEKEY AND CREATEDATE = ''' || CREATEDATE || ''')
						' || OwnerPartSql || PlantPartSql || ' 
						WHERE MOSTRECENT = ''T'' AND ISDATE(' || :IN_UsingField || ') = 1 AND ' || :IN_UsingField || ' BETWEEN ''' || IN_DateFrom || ''' AND ''' || IN_DateTo || ''') result' || LimitDueTypePartSql;
		END
	END

	IF (SQL IS NULL) THEN
	BEGIN
		SQL = 'SELECT	UNIQUEKEY,
						EQUIPTYPE,
						LOOPNUMBER,
						TAGNUMBER,
						SERIAL,
						UNIT,
						EQUIPLOCN,
						STATUS,  
						JOBNUMBER,
						MODELNUMBER,
						MANUFACTURER,
						RISK,
						DATETESTED,
						NEXTMAINDATE,
						NEXTTESTDATE,
						NEXTINSPDATE,
						NEXTMAINDATE BOTHDATE,
						0 REPAIRDAYDUE,
                        NULL AS DATEDUE,
						0 DAYDUE,
						0 WEEKDUE,
						0 MONTHDUE,
						0 YEARDUE FROM	TEMPNEXTMAINTLIST WHERE 1=2';
	END

	SUSPEND;
END^
SET TERM ; ^ 

